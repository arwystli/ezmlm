<?php

function ezmlm_system($field){
  $system["description"] = t("Modules that adds some utilities related to ezmlm, like a box for subscribing to list.");
  return $system[$field];
}

function ezmlm_settings() {
  $output .= form_textfield(t("email lists"), "ezmlm_lists", variable_get("ezmlm_lists", ""), 80, 255, t("Lists of ezmlm mailing list with this format <i>list name 1 , list1@domain.org | list name 2 , list2@domain.org</i>"));

  $output .= form_textarea(t("\"Subscribe to\" message"), "ezmlm_subscribe_message", variable_get("ezmlm_subscribe_message", ""), 55, 4, "This text will be displayed at the top of the ezmlm form.");

  return $output;
}


function ezmlm_block($op = "list", $delta = 0) {
  if ($op == "list") {
    $blocks[0]["info"] = t("ezmlm subscribe to list");
    return $blocks;
  }
  else {
    switch ($delta) {
      case 0:
        $block["subject"] = t("Subscribe to list");
	ob_start();
	_ezmlm_subscribe_form();
	$block["content"] = ob_get_contents();
	ob_end_clean();
        return $block;
    }
  }
}  

function ezmlm_page() {
  $ezmlm_subscribe = $_POST["ezmlm_subscribe"];

  theme("header");

  if (isset($ezmlm_subscribe))
    _ezmlm_subscribe_process();
  else 
    _ezmlm_subscribe_form();

  theme("footer");
}

function _ezmlm_subscribe_process() {
		
  $ezmlm_subscribe = $_POST["ezmlm_subscribe"];

  /*
   ** Verify the syntax of the given e-mail address.  Empty e-mail addresses
   ** allowed.  See RFC 2822 for details.
   */
  $user = '[a-zA-Z0-9_\-\.\+\^!#\$%&*+\/\=\?\`\|\{\}~\']+';
  $domain = '(?:[a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9]\.?)+';
  $ipv4 = '[0-9]{1,3}(\.[0-9]{1,3}){3}';
  $ipv6 = '[0-9a-fA-F]{1,4}(\:[0-9a-fA-F]{1,4}){7}';
  if (!$ezmlm_subscribe[email]) {
    print t("you didn't enter an email address");
  }
  else if ($ezmlm_subscribe[email] && !preg_match("/^$user@($domain|(\[($ipv4|$ipv6)\]))$/", $ezmlm_subscribe[email])) { 
    print $ezmlm_subscribe[email] . t("this is not a valid address, please go back") ;
  }
  
  else {
    preg_match("/^($user)@(($domain)$)/i",$ezmlm_subscribe[email], $match_user);
    $user_name = $match_user[1];
    $user_domain = $match_user[2];
    
    print "<p><b>" .t("You will receive a confirmation email in few minutes to register in the following lists:"). "</b><p>";

      
    $all_lists = explode("|",variable_get("ezmlm_lists",""));
    foreach($all_lists as $alist) {
      $alist = explode(",",$alist);
      $list_email = trim($alist[1]);
      
      if (isset($ezmlm_subscribe[$list_email])) {
	preg_match("/^($user)@(($domain)$)/i",$list_email, $match_list);
	$list_name = $match_list[1];
	$list_domain = $match_list[2];

	$address =  $list_name . "-subscribe-".$user_name."=".$user_domain."@".$list_domain;
	
	mail($address,"","");
	print $list_email ."<br>";
      }
    }
  }
}

function _ezmlm_subscribe_form()  {
  
  $all_lists = explode("|",variable_get("ezmlm_lists",""));
  foreach($all_lists as $alist) {
    $alist = explode(",",$alist);
    $lists[$alist[1]] = $alist[0];
  }
   
  //////////////////////////////////////////////
  // Formulaire
  //////////////////////////////////////////////
  print "<form name=\"ezmlm_subscribe\" method=\"post\" action=\"?q=ezmlm\">\n";
  
  
  if (sizeof($lists) > 1) {
    print "<input type=\"text\" name=\"ezmlm_subscribe[email]\" value=\"". t("your email") ."\"><p>\n";
    print "<b>".t("Subscribe to").": </b><p >\n";
    foreach ($lists as $list_email => $list_text) {
      print "<input type=\"checkbox\" name=\"ezmlm_subscribe[". trim($list_email) ."]\">".trim($list_text).".<br>\n";
    } 
  }
  else {
    reset($lists);
    print "<b>" .t("Subscribe to") . " " .key($lists) ."</b><p>\n";
    print "<input type=\"text\" name=\"ezmlm_subscribe[email]\" value \"". t("your email")."\"><p>\n";
    print "<input type =\"hidden\" name=\"ezmlm_subscribe[". key($lists) ."]\"value =\"1\">\n";
  }
  
  echo "<p><input type=\"submit\" value=\"".t("submit") ."\"></form>";

}

?>
