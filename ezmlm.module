<?php
// $Id$
// $Name$

function ezmlm_help($section) {
  switch($section) {
    case 'admin/system/modules#description':
      return t('Utilities related to ezmlm, like a box for subscribing to list.');
  }
}

function ezmlm_link($type, $node = 0) {
  if (($type == "system")) {
    menu("ezmlm", t("mailing lists"), "ezmlm_page", '', MENU_HIDE);
  }
}

function ezmlm_settings() {
  $output .= form_textfield(t("email lists"), "ezmlm_lists", variable_get("ezmlm_lists", ""), 80, 255, t("Lists of ezmlm mailing list with this format <i>list name 1 , list1@domain.org | list name 2 , list2@domain.org</i>"));

  return $output;
}

function ezmlm_block($op = "list", $delta = 0) {
  if ($op == "list") {
    $blocks[0]["info"] = t("ezmlm subscribe to list(s)");
    return $blocks;
  }
  else if (arg(0) != 'ezmlm') {
    switch ($delta) {
      case 0:
        $block["subject"] = t("Subscribe to %list", array('%list' => format_plural(count(explode("|", variable_get("ezmlm_lists", ""))), 'list', 'lists')));
        $block["content"] = _ezmlm_subscribe_form();
        return $block;
    }
  }
}  

function ezmlm_page() {
  if ($_POST['edit']) {
    $output = _ezmlm_subscribe_process();
  }
  else {
    $output = _ezmlm_subscribe_form();
  }
  print theme('page', $output, t("Subscribe to %list", array('%list' => format_plural(count(explode("|", variable_get("ezmlm_lists", ""))), 'list', 'lists'))));
}

function _ezmlm_subscribe_process() {
  $edit = $_POST['edit'];

  /*
   ** Verify the syntax of the given e-mail address.  Empty e-mail addresses
   ** allowed.  See RFC 2822 for details.
   */
  $user = '[a-zA-Z0-9_\-\.\+\^!#\$%&*+\/\=\?\`\|\{\}~\']+';
  $domain = '(?:[a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9]\.?)+';
  $ipv4 = '[0-9]{1,3}(\.[0-9]{1,3}){3}';
  $ipv6 = '[0-9a-fA-F]{1,4}(\:[0-9a-fA-F]{1,4}){7}';
  if (!$edit['email']) {
    drupal_set_message(t('You did not enter your email address.'), 'error');
    return _ezmlm_subscribe_form();
  }
  if ($edit['email'] && !preg_match("/^$user@($domain|(\[($ipv4|$ipv6)\]))$/", $edit['email'])) { 
    drupal_set_message(t('The email address you entered is not valid.'), 'error');
    return _ezmlm_subscribe_form();
  }
  list($user_name, $user_domain) = split('@', $edit['email']);
  $lists = array();
  foreach(explode('|', variable_get('ezmlm_lists', '')) as $list) {
    list($list_text, $list_email) = explode(',', $list);
    if ($edit['list'][trim($list_email)]) {
      list($list_name, $list_domain) = split('@', $list_email);
      mail(trim($list_name) .'-subscribe-'. trim($user_name) .'='. trim($user_domain) .'@'. trim($list_domain), '', '');
      $lists[] = trim($list_email);
    }
  }
  drupal_set_message(t('You will receive a confirmation email in few minutes to register in the following %lists: ', array('%lists' => format_plural(count($lists), 'list', 'lists'))) . implode(', ', $lists));
  return '';
}

function _ezmlm_subscribe_form() {
  $output .= form_textfield(t('Your email address'), 'email', '', 20, 80);
  foreach(explode('|', variable_get('ezmlm_lists', '')) as $list) {
    list($list_text, $list_email) = explode(',', $list);
    $output .= form_checkbox(trim($list_text), 'list]['. trim($list_email), 1, 0);
  }
  $output .= form_submit(t('Subscribe'));
  return form($output, 'POST', url('ezmlm'));
}

?>
