<?php
// $Id$
// $Name$

/**
 * @file
 * Allows users to subscribe to EZMLM mailing lists via a form in
 * a block or page.  List of mailing lists is defined by adminstrator.
 * Module sends subscription requests to each list's subscribe address.
 */

/**
 * Implementation of hook_help().
 */
function ezmlm_help($section) {
  switch ($section) {
    case 'admin/modules#description':
      return t('Utilities related to ezmlm, like a box for subscribing to list.');
  }
}

/**
 * Implementation of hook_link().
 */
function ezmlm_link($type, $node = NULL, $teaser = FALSE) {
  $links = array();

  if ($type == 'page' && user_access('access content')) {
    $links[] = l(t('mailing %list', array('%list' => format_plural(_ezmlm_get_count(), 'list', 'lists'))), 'ezmlm', array('title' => t('Subscribe to mailing %list', array('%list' => format_plural(_ezmlm_get_count(), 'list', 'lists')))));
  }

  return $links;
}

/**
 * Implementation of hook_perm().
 */
function ezmlm_perm() {
  return array('administer ezmlm');
}

/**
 * Implementation of hook_menu().
 */
function ezmlm_menu($may_cache) {
  $items = array();

  if ($may_cache) {
    $items[] = array('path' => 'ezmlm/add',
      'title' => ('mailing lists'),
      'callback' => 'ezmlm_block',
      'access' => user_access('access content'),
      'type' => MENU_CALLBACK);

    $items[] = array('path' => 'ezmlm',
      'title' => ('mailing lists'),
      'callback' => 'ezmlm_page',
      'access' => user_access('access content'),
      'type' => MENU_NORMAL_ITEM);

    $items[] = array('path' => 'admin/ezmlm',
      'title' => t('ezmlm lists'),
      'access' => user_access('administer ezmlm'),
      'callback' => 'ezmlm_admin',
      'type' => MENU_NORMAL_ITEM);
  }
  return $items;
}

/**
 * Implementation of hook_block().
 *
 * Generates a block with the subscription form.
 */
function ezmlm_block($op = 'list', $delta = 0) {
  switch ($op) {
    case 'list':
      $blocks[0]['info'] = t('ezmlm subscribe to list(s)');
      return $blocks;
    case 'view':
      if (arg(0) != 'ezmlm') {
        switch ($delta) {
          case 0:
            if (strlen(trim(variable_get('ezmlm_lists', '')))) {
                $block['subject'] = t('Subscribe to mailing %list', array('%list' => format_plural(_ezmlm_get_count(), 'list', 'lists')));
                $block['content'] = '';
                if (isset($_POST['edit']['subscribe']['ezmlm_list'])) {
                    $msg = _ezmlm_subscribe_process();
                    $block['content'] .= $msg[0];
                }
                $block['content'] .= _ezmlm_subscribe_form();
            }
            return $block;
        }
      }
      break;
    case 'configure':
    case 'save':
      return;
  }
}  

/**
 * Menu callback; presents the subscription form on a page, or processes
 * that form's input, whether from block or page.
 */
function ezmlm_page() {
  if (isset($_POST['edit']['subscribe']['ezmlm_list'])) {
    $msg = _ezmlm_subscribe_process();
    $msgtype = isset($msg[1]) ? $msg[1] : 'status';
    drupal_set_message($msg[0], $msgtype);
  }
  $output = _ezmlm_subscribe_form();
  drupal_set_title(t('Subscribe to mailing %list', array('%list' => format_plural(_ezmlm_get_count(), 'list', 'lists'))));
  return $output;
}

/**
 * Process the subscription form input; does some address checks and 
 * sends mail to the EZMLM subscribe addresses for the lists.
 */
function _ezmlm_subscribe_process() {
  $edit = $_POST['edit']['subscribe'];
  /*
   * Verify the syntax of the given e-mail address.  Empty e-mail addresses
   * allowed.  See RFC 2822 for details.
   */
  $user = '[a-zA-Z0-9_\-\.\+\^!#\$%&*+\/\=\?\`\|\{\}~\']+';
  $domain = '(?:[a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9]\.?)+';
  $ipv4 = '[0-9]{1,3}(\.[0-9]{1,3}){3}';
  $ipv6 = '[0-9a-fA-F]{1,4}(\:[0-9a-fA-F]{1,4}){7}';
  if (!$edit['ezmlm_email']) {
    return  array(t('You did not enter your email address.'), 'error');
  }
  if ($edit['ezmlm_email'] && !preg_match("/^$user@($domain|(\[($ipv4|$ipv6)\]))$/", $edit['ezmlm_email'])) { 
    return Array('The email address you entered is not valid.', 'error');
  }
  list($user_name, $user_domain) = split('@', $edit['ezmlm_email']);
  $lists = _ezmlm_get_lists();
  foreach ($lists as $list_text => $list_email) {
    if ($edit['ezmlm_list'][trim($list_email)] == 1) {
      list($list_name, $list_domain) = split('@', $list_email);
      // subscribe address for list formatted below
      mail(trim($list_name) .'-subscribe-'. trim($user_name) .'='. trim($user_domain) .'@'. trim($list_domain), '', '');
      $mylists[] = trim($list_email);
    }
  }

  return Array(t('You will receive a confirmation email in few minutes to register in the following %lists: ', array('%lists' => format_plural(count($mylists), 'list', 'lists'))) . implode(', ', $mylists), 'success');
}

/**
 * Generates the subscription form.
 *
 * @return
 *  HTML form.
 */
function _ezmlm_subscribe_form() {
  $lists = _ezmlm_get_lists();
  if (count($lists) == 0) {
    return t('There are no lists available for subscription.'); // formatting?
  }
  $form['#action'] = request_uri(); // is this format even right?
  $form['subscribe']['#tree'] = TRUE; // is this format even right?
  $form['subscribe'] = array('#type' => 'fieldset',
                            '#tree' => TRUE,
                            '#prefix' => '<div class="ezmlm">',
                            '#suffix' => '</div>'); // fixme
  $form['subscribe']['ezmlm_email'] = 
                     array ('#type' => 'textfield',
                            '#title' => t('Your email address'),
                            '#default_value' => '',
                            '#size' => 20,
                            '#maxlength' => 80 );
  if (count($lists) == 1) {
    list($list_text, $list_email) = each($lists); // list() only works on numeric arrays
    $form['subscribe']['ezmlm_list'][trim($list_email)] = 
                          array('#type' => 'hidden', '#value' => 1); // fixme
  }
  else { 
    foreach ($lists as $list_text => $list_email) {
      $form['subscribe']['ezmlm_list'][trim($list_email)] =
                            array('#type' => 'checkbox',
                                  '#title' => trim($list_text),
                                  '#tree' => TRUE,
                                  '#default_value' => FALSE,
                                  '#return_value' => 1); // fixme
    }
  }

  $form['submit'] = array('#type' => 'submit', '#value' => t('Subscribe'));
  return drupal_get_form('_ezmlm_subscribe_form', $form);
}

/**
 * Menu callback; displays the mailing list overview/editing page.
 */
function ezmlm_admin() {
  return _ezmlm_admin_display();        // Drupal 4.7
}

function _ezmlm_admin_display_add_execute($form_id, $form) {
  drupal_set_message(_ezmlm_admin_save($form));
  drupal_goto('admin/ezmlm');
}

function _ezmlm_admin_display_delete_execute($form_id, $form) {
  drupal_set_message(_ezmlm_admin_delete($form['status']));
  drupal_goto('admin/ezmlm');
}

/**
 * Prepare the mailing list admin form.
 */
function _ezmlm_admin_display() {
  $form['#action'] = url('admin/ezmlm');  // this may be the default and unnecessary
  $form['ezmlm_admin'] = array('#type' => 'markup',
                               '#value' => '<div class="ezmlm">');
  $lists = _ezmlm_get_lists();
  if (count($lists) > 0) {
    $listnum = 0;
    foreach ($lists as $name => $address) {
      $listnum++;
      $form['name'][$name] = array('#value' => $name);
      $form['address'][$name] = array('#value' => $address);
      $options[$name] = '';
    }

    $form['status'] = array('#type' => 'checkboxes',
                            '#default_value' => '',
                            '#options' => $options,
                            '#return_value' => 1,
                            '#tree' => TRUE);
    
    $form['delete'] = array('#type' => 'submit',
                                       '#value' => t('Delete checked lists'));
    $output = drupal_get_form('_ezmlm_admin_display_delete', $form);
  }
  $form = array();
  $form['ezmlm_add_name'] = array('#type' => 'textfield',
                            '#title' => t('New list name'),
                            '#size' => 20,
                            '#maxlength' => 20);
  $form['ezmlm_add_address'] = array('#type' => 'textfield',
                               '#title' => t('New list address'),
                               '#size' => 30,
                               '#maxlength' => 50);
  $form['add'] = array('#type' => 'submit',
                                     '#value' => t('Add list'));

  $form['ezmlm_admin'] = array('#type' => 'markup', '#value' => '</div>');

  $output .= drupal_get_form('_ezmlm_admin_display_add', $form);
  return $output;
}

function theme__ezmlm_admin_display_delete($form) {
  foreach (element_children($form['name']) as $key) {
    $row = array();
    $row[] = form_render($form['name'][$key]);
    $row[] = form_render($form['address'][$key]);
    $row[] = array('data' => form_render($form['status'][$key]));
    $rows[] = $row;
  }
  $header = array(t('Name'), t('Address'), '');
  $output = theme('table', $header, $rows);
  $output .= form_render($form);
  return $output;
}

/**
 * Save new mailing list.
 */
function _ezmlm_admin_save($edit) {
  $lists = _ezmlm_get_lists();
  if (!is_array($lists)) {
    $lists = array();
  }
  $name = trim($edit['ezmlm_add_name']);
  $address = trim($edit['ezmlm_add_address']);
  if (strlen($name) && strlen($address)) {
    $lists[$name] = $address;
  }
  variable_set('ezmlm_lists', serialize($lists));
  return t('The mailing lists have been updated.');
}

/**
 * Delete a mailing list.
 */
function _ezmlm_admin_delete($edit) {
  $lists = _ezmlm_get_lists();
  if (!is_array($lists)) {
    return t('No lists to delete.');
  }
  $newlists = array();
  foreach ($lists as $name => $address) {
    if (array_key_exists($name, $edit) && $edit[$name] == 1) {
      continue;     // skip copying this list to the new list
    }
    else {
      $newlists[$name] = $address;   // copy old list entry to new
    }
  }
  variable_set('ezmlm_lists', serialize($newlists));
  return t('The mailing lists have been updated.');
}

/**
 * Return current number of lists.
 */
function _ezmlm_get_count() {
  $lists = _ezmlm_get_lists();
  if (!is_array($lists)) {
    return 0;
  }
  else {
    return count($lists);
  }
}

/**
 * Return array of current mailing lists.
 */
function _ezmlm_get_lists() {
  return unserialize(variable_get('ezmlm_lists', ''));
}

?>
