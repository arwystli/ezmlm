<?php
// $Id$
// $Name$
// for drupal 5.x

/**
 * @file
 * Allows users to subscribe to EZMLM mailing lists via a form in
 * a block or page.  List of mailing lists is defined by adminstrator.
 * Module sends subscription requests to each list's subscribe address.
 */

/**
 * Implementation of hook_user().
 * by mjs2020
 * this adds the ability to subscribe to mailing lists
 * during the registration process.
 */
function ezmlm_user($op, &$edit, &$account, $category = NULL) {
  switch ($op) {
    case 'register':
      if ( variable_get('ezmlm_register', 0) && variable_get('ezmlm_register_list', 0) ) {
        $listsform = _ezmlm_subscribe_form('REG', variable_get('ezmlm_reg_display', 'email'));
        unset($listsform['ezmlm_email'], $listsform['submit'], $listsform['subscribe'] );

        $form['ezmlm'] = array(
          "#type" => "fieldset",
          "#title" => t("Mailing lists"),
          "#description" => t("Please select the mailing lists you would like to subscribe to."),
          '#collapsible' => FALSE,
          "#tree" => FALSE,
          "#parents" => array("ezmlm"),
        );
        $form['ezmlm']['ezmlm_subscribe'] = array();
        foreach ($listsform['ezmlm_subscribe'] as $key => $ezmlm_list) {
          $ezmlm_list['#parents'][0] = $key;
          $ezmlm_list['#name'] = $key;
          $form['ezmlm']['ezmlm_subscribe'][$key] = $ezmlm_list;
        }
        return $form;
      }
      break;
    case 'insert':
      if ( variable_get('ezmlm_register', 0) && variable_get('ezmlm_register_list', 0) ) {
        $lists = _ezmlm_get_lists('REG');
        $listct = _ezmlm_get_count('REG');
        $arr = array();
        // get the selected mailing list addresses
        for ($ct=1; $ct <= $listct; $ct++) {
          if (isset($edit["ezmlm_list_$ct"])) {
            $address = $edit["ezmlm_list_$ct"];
            if ($address && in_array($address, $lists)) {
              $arr[] = $address;
            }
          }
        }
        $email = trim($edit['mail']);
        $ret = _ezmlm_subscribe_process($arr, $email);
        if (is_array($ret)) {
          $output = (t('Please check your mail at %mail to confirm registration of:', array('%mail' => $email)));
          drupal_set_message($output ."<br />". implode('<br />', $ret));
        }
        else {
          drupal_set_message($ret, 'error');
        }
      }
      break;
  }
}

/**
 * Implementation of hook_help().
 */
function ezmlm_help($section) {
  switch ($section) {
    case 'admin/modules#description':
      return t('Utilities related to ezmlm, such as a box for subscribing to list(s).');
  }
}

/**
 * Implementation of hook_link().
 */
function ezmlm_link($type, $node = NULL, $teaser = FALSE) {
  $links = array();
  if ($type == 'page' && user_access('access content')) {
    $links[] = l(t('mailing %list', array('%list' => format_plural(_ezmlm_get_count(), 'list', 'lists'))), 'ezmlm', array('title' => t('Subscribe to mailing %list', array('%list' => format_plural(_ezmlm_get_count(), 'list', 'lists')))));
  }
  return $links;
}

/**
 * Implementation of hook_perm().
 */
function ezmlm_perm() {
  return array('administer ezmlm');
}

/**
 * Implementation of hook_menu().
 */
function ezmlm_menu($may_cache) {
  $items = array();
  if ($may_cache) {
    $items[] = array(
      'path' => 'ezmlm/add',
      'title' => t('Mailing lists'),
      'callback' => 'ezmlm_block',
      'access' => user_access('access content'),
      'type' => MENU_CALLBACK,
    );
    $items[] = array(
      'path' => 'ezmlm',
      'title' => t('Mailing lists'),
      'callback' => 'ezmlm_page',
      'access' => user_access('access content'),
      'type' => MENU_NORMAL_ITEM,
    );
    $items[] = array(
      'path' => 'admin/settings/ezmlm',
      'title' => t('Ezmlm lists'),
      'description' => t('Ezmlm mailing lists management.'),
      'access' => user_access('administer ezmlm'),
      'callback' => 'drupal_get_form',
      'callback arguments' => array('ezmlm_settings'),
      'type' => MENU_NORMAL_ITEM,
    );
  }
  return $items;
}

/**
 * Implementation of hook_block().
 *
 * Generates a block with the subscription form.
 */
function ezmlm_block($op = 'list', $delta = 0) {
  switch ($op) {
    case 'list':
      $blocks[0]['info'] = t('ezmlm subscribe to list(s)');
      return $blocks;
    case 'view':
      if (arg(0) != 'ezmlm') {
        switch ($delta) {
          case 0:
            $block = "";
            if (drupal_strlen(trim(variable_get('ezmlmmailinglists', '')))) {
              $block['subject'] = variable_get('ezmlm_block_title', t('Subscriptions'));
              $block['content'] .= ezmlm_page(variable_get('ezmlm_block_display', 'email'));
            }
            return $block;
        }
      }
      break;
    case 'configure':
    case 'save':
      return;
  }
}

/**
 * Menu callback; presents the subscription form on a page, or processes
 * that form's input, whether from block or page.
 */
function ezmlm_page($display='') {
  if (! $display) {
    $display = variable_get('ezmlm_display', 'email');
  }
  $output = drupal_get_form('_ezmlm_subscribe_form', 'DEFAULT', $display);
  return $output;
}

/**
 * Menu callback; presents the settings form for ezmlm
 */
function ezmlm_settings() {
  $form = array();
  // add mailing list
  $form['ezmlm_add'] = array(
    '#type' => 'fieldset',
    '#title' => t('Add mailing lists'),
    '#description' => t('Add new lists'),
    '#collapsible' => TRUE,
  );
  $form['ezmlm_add']['ezmlm_add_name'] = array(
    '#type' => 'textfield',
    '#title' => t('New list name'),
    '#size' => 20,
    '#maxlength' => 20,
    '#required' => FALSE,
  );
  $form['ezmlm_add']['ezmlm_add_address'] = array(
    '#type' => 'textfield',
    '#title' => t('New list address'),
    '#size' => 30,
    '#maxlength' => 50,
    '#required' => FALSE,
  );

  // Delete mailing lists
  if (_ezmlm_get_count() > 0) {
    $form['ezmlm_delete'] = array(
      '#type' => 'fieldset',
      '#title' => t('Remove mailing lists'),
      '#description' => t('Check the lists you want to remove'),
      '#collapsible' => TRUE,
    );

    $lists = variable_get('ezmlmmailinglists', '');
    if (is_array($lists)) {
      foreach ($lists as $list_text => $list_email) {
        $list_text2 = preg_replace('/\s/', '~', $list_text);
        $form['ezmlm_delete'][$list_text2] = array(
          '#type' => 'checkbox',
          '#title' => "$list_text ($list_email)" ,
        );
      }
    }
    // registration
    $form['ezmlm_reg'] = array(
      '#type' => 'fieldset',
      '#title' => t('Registration settings'),
      '#description' => t('Allow new users to select mailing lists on registration'),
      '#collapsible' => TRUE,
    );
    $form['ezmlm_reg']['ezmlm_register'] = array(
      '#type' => 'checkbox',
      '#title' => t('Display lists in registration form'),
      '#default_value' => variable_get('ezmlm_register', 1),
    );
    if (is_array($lists)) {
      $reglist = variable_get('ezmlm_register_list', '');
      foreach ($lists as $list_text => $list_email) {
        $list_text2 = preg_replace('/\s/', '~', $list_text);
        $form['ezmlm_reg']["reg_$list_text2"] = array(
          '#type' => 'checkbox',
          '#title' => "$list_text ($list_email)" ,
          '#default_value' => ((is_array($reglist) && in_array($list_email, $reglist)) ? 1 : 0),
        );
      }
    }
    $form['ezmlm_reg']['ezmlm_reg_display'] = array(
      '#type' => 'radios',
      '#title' => t('List display type'),
      '#default_value' => variable_get('ezmlm_reg_display', 'email'),
      '#options' => array('email' => 'List address', 'name' => 'List name'),
      '#description' => t('Display %listaddress or %listname on the registration page', array('%listaddress' => 'list address', '%listname' => 'list name')),
    );
  }

  $form['ezmlm_misc'] = array(
      '#type' => 'fieldset',
      '#title' => t('Various settings'),
      '#collapsible' => TRUE,
  );
  $form['ezmlm_misc']['ezmlm_title'] = array(
    '#type' => 'textfield',
    '#title' => t('List title'),
    '#description' => t('Configure the title of the subscription page'),
    '#default_value' => variable_get('ezmlm_title', t('Mailing lists')),
    '#size' => 20,
    '#maxlength' => 20,
    '#required' => FALSE,
  );
  $form['ezmlm_misc']['ezmlm_display'] = array(
    '#type' => 'radios',
    '#title' => t('List display type'),
    '#default_value' => variable_get('ezmlm_display', 'email'),
    '#options' => array('email' => 'List address', 'name' => 'List name'),
    '#description' => t('Display %listaddress or %listname on the subscription page', array('%listaddress' => 'list address', '%listname' => 'list name')),
  );
  $form['ezmlm_misc']['ezmlm_block_title'] = array(
    '#type' => 'textfield',
    '#title' => t('Block title'),
    '#description' => t('Configure the title of the block subscription page'),
    '#default_value' => variable_get('ezmlm_block_title', t('Subscriptions')),
    '#size' => 20,
    '#maxlength' => 20,
    '#required' => FALSE,
  );
  $form['ezmlm_misc']['ezmlm_block_display'] = array(
    '#type' => 'radios',
    '#title' => t('Block display type'),
    '#default_value' => variable_get('ezmlm_block_display', 'email'),
    '#options' => array('email' => 'List address', 'name' => 'List name'),
    '#description' => t('Display %listaddress or %listname on the block subscription page', array('%listaddress' => 'list address', '%listname' => 'list name')),
  );

  return system_settings_form($form);
}

/**
 * Validate form
 */
function ezmlm_settings_validate($form_id, $form_values) {

  if (drupal_strlen($form_values['ezmlm_add_address'])) {
    if ($error = user_validate_mail($form_values['ezmlm_add_address'])) {
      form_set_error('ezmlm_add_address', $error);
    }
    if (! drupal_strlen($form_values['ezmlm_add_name'])) {
      form_set_error('ezmlm_add_name', t('You must fill in the Name field'));
    }
  }
}

/**
 * Submit form
 */
function ezmlm_settings_submit($form_id, $form_values) {
  // various
  if ($form_values['ezmlm_title'] != "") {
    variable_set('ezmlm_title', $form_values['ezmlm_title']);
  }
  if ($form_values['ezmlm_block_title'] != "") {
    variable_set('ezmlm_block_title', $form_values['ezmlm_block_title']);
  }
  // look for deletes
  $lists = _ezmlm_get_lists();
  if (is_array($lists)) {
    // deletions
    $newlists = array();
    $delct = 0;
    foreach ($lists as $list_text => $list_email) {
      $list_text = preg_replace('/\s/', '~', $list_text);
      if (isset($form_values[$list_text]) && $form_values[$list_text] == 1) {
        $delct++;
        continue;     // skip copying this list to the new list
      }
      else {
        $list_text = preg_replace('/~/', ' ', $list_text);
        $newlists[$list_text] = $list_email;   // copy old list entry to new
      }
    }
    if (count($newlists) < count($lists)) {
      variable_set('ezmlmmailinglists', $newlists);
      drupal_set_message(t('Deletions done.'));
    }
  }
  // add list
  $lists = _ezmlm_get_lists();
  $count = _ezmlm_get_count();
  if (!is_array($lists) || $count < 1 ) {
    $lists = array();
    variable_del('ezmlmmailinglists');
  }
  $list_text = trim($form_values['ezmlm_add_name']);
  $list_email = trim($form_values['ezmlm_add_address']);
  if (drupal_strlen($list_text) && drupal_strlen($list_email)) {
    $lists[$list_text] = $list_email;
    variable_set('ezmlmmailinglists', $lists);
    drupal_set_message( t('The mailing lists have been saved.'));
  }
  // registration
  if ($form_values['ezmlm_register']) {
    variable_set('ezmlm_register', 1);
  }
  else {
    variable_set('ezmlm_register', 0);
  }
  if ( variable_get('ezmlm_register', 0) ) {
    // reg list
    if (is_array($lists) && $count > 0) {
      variable_del('ezmlm_register_list');
      $arr = array();
      foreach ($lists as $list_text => $list_email) {
        $list_text = preg_replace('/\s/', '~', $list_text);
        if ( isset($form_values["reg_$list_text"]) && $form_values["reg_$list_text"] == 1 ) {
          $list_text = preg_replace('/~/', ' ', $list_text);
          $arr[$list_text] = $list_email;
        }
      }
      if ( count($arr) ) {
        variable_set('ezmlm_register_list', $arr);
      }
    }
  }
  // display
  if ( $form_values['ezmlm_display'] ) {
    variable_set('ezmlm_display', $form_values['ezmlm_display']);
  }
  if ( $form_values['ezmlm_block_display'] ) {
    variable_set('ezmlm_block_display', $form_values['ezmlm_block_display']);
  }
  if ( $form_values['ezmlm_reg_display'] ) {
    variable_set('ezmlm_reg_display', $form_values['ezmlm_reg_display']);
  }
}

// internal functions
/**
 * Generates the subscription form.
 *
 * @return
 *  HTML form.
 */
function _ezmlm_subscribe_form($type='DEFAULT', $display='email') {
  global $user;

  $listct = _ezmlm_get_count($type);
  if ($listct == 0) {
    return t('There are no lists available for subscription.'); // formatting?
  }
  $lists = _ezmlm_get_lists($type);

  $form['subscribe'] = array(
    '#type' => 'markup',
    '#value' => variable_get('ezmlm_title', t('Mailing lists')),
  );
  $ct = 1;
  foreach ($lists as $list_text => $list_email) {
    $list_email = trim($list_email);
    $form['ezmlm_subscribe']["ezmlm_list_$ct"] = array(
      '#type' => 'checkbox',
      '#title' => ($display=='name' ? $list_text : $list_email),
      '#return_value' => $list_email,
    );
    $ct++;
  }
  $form['ezmlm_email'] = array(
    '#type' => 'textfield',
    '#title' => t('Your email address'),
    '#default_value' => ($user->mail ? $user->mail : ''),
    '#size' => 20,
    '#maxlength' => 80,
  );
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Subscribe')
  );

  return $form;
}

function _ezmlm_subscribe_form_validate($form_id, $form_values) {
  $arr = array();
  $lists = _ezmlm_get_lists();
  $ct = 1;
  foreach ($form_values as $key => $address) {
    $address = trim($address);
    if ($key == "ezmlm_list_$ct" && $address && in_array($address, $lists)) {
      $arr[] = $address;
    }
    $ct++;
  }
  if (count($arr) < 1) {
    form_set_error('', t('No lists selected!'));
  }
  if ($error = user_validate_mail($form_values['ezmlm_email'])) {
    form_set_error('ezmlm_email', $error);
  }
}

function _ezmlm_subscribe_form_submit($form_id, $form_values) {
  $lists = _ezmlm_get_lists();
  $arr = array();
  $ct = 1;
  // get the selected mailing list addresses
  foreach ($form_values as $key => $address) {
    $address = trim($address);
    if ($key == "ezmlm_list_$ct" && $address && in_array($address, $lists)) {
      $arr[] = $address;
    }
    $ct++;
  }
  $email = trim($form_values['ezmlm_email']);
  $ret = _ezmlm_subscribe_process($arr, $email);
  if (is_array($ret)) {
    $output = (t('Please check your mail at %mail to confirm registration of:', array('%mail' => $email)));
    drupal_set_message($output ."<br />". implode('<br />', $ret));
  }
  else {
    drupal_set_message($ret, 'error');
  }
}

/**
 * Process the subscription form input; does some address checks and
 * sends mail to the EZMLM subscribe addresses for the lists.
 */
function _ezmlm_subscribe_process($subs, $mail) {
  $err = "";
  list($user_name, $user_domain) = split('@', $mail);
  $lists = _ezmlm_get_lists();
  $mylists = array();
  // loop over the lists
  foreach ($lists as $list_text => $list_email) {
    // loop over the subs
    foreach ($subs as $address) {
      if ($list_email == $address) {
        list($list_name, $list_domain) =  split('@', $list_email);
        // subscribe address for list formatted below
        $to = trim($list_name) .'-subscribe-'. trim($user_name) .'='. trim($user_domain) .'@'. trim($list_domain);
        mail($to, '', '');
        $mylists[] = trim($list_email);
      }
    }
  }
  return ($mylists);
}

/**
 * Return current number of lists.
 * Use this instead of count(_ezmlm_get_lists()) because non-array counts as 1.
 */
function _ezmlm_get_count($type='DEFAULT') {
  $lists = _ezmlm_get_lists($type);
  if (!is_array($lists)) {
    return 0;
  }
  else {
    return count($lists);
  }
}

/**
 * Return array of current mailing lists.
 */
function _ezmlm_get_lists($type='DEFAULT') {
  if ($type=='DEFAULT') {
    return variable_get('ezmlmmailinglists', '');
  }
  elseif ($type=='REG') {
    return variable_get('ezmlm_register_list', '');
  }
}

